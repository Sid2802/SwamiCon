package com.example.Swamicon.service;

import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.example.Swamicon.dto.AuthResponse;
import com.example.Swamicon.dto.LoginResponse;
import com.example.Swamicon.dto.RegisterResponse;
import com.example.Swamicon.entity.Role;
import com.example.Swamicon.entity.User;
import com.example.Swamicon.repository.UserRepository;
import com.example.Swamicon.utility.JwtUtil;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class AuthService {
	private final UserRepository userRepository;
	private  final PasswordEncoder passwordEncoder;
	private final JwtUtil jwtUtil;
	
	//Register
	public String register(RegisterResponse request) {
		if(userRepository.findByEmail(request.getEmail()).isPresent()) {
			throw new RuntimeException("Email already registered");
		}
		
		User user=User.builder()
				.fullName(request.getFullName())
				.email(request.getEmail())
				.password(passwordEncoder.encode(request.getPassword()))
				.role(Role.valueOf(request.getRole().toUpperCase()))
				.build();
		
		userRepository.save(user);
		return "User Registered Successfully";
	}
	
	//Login
	public AuthResponse ogin(LoginResponse request) {
		//Fetch user once
		User user=userRepository.findByEmail(request.getEmail())
				.orElseThrow(()->new RuntimeException("User not found"));
		
		//Check Password
		if(!passwordEncoder.matches(request.getEmail(), user.getPassword())) {
			throw new RuntimeException("Invalid Credintials");
		}
		
		//Generate token
		String token =jwtUtil.generateToken(user.getEmail());
		
		//Return clean role without text
		System.out.println("Logging role for users: "+user.getRole().name());
		
		return new  AuthResponse(token,user.getRole().name());
	}
		

}
